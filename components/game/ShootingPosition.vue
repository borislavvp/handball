<template>
  <div >
    <svg
      ref="svgRef"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 930 333"
      class="w-full h-auto max-w-[930px]"
    >
      <!-- Outer dashed border -->
     <path d="M919.524 0V1.5H924.615L921.969 7.00586L923.32 7.65527L915.961 22.9668L914.609 22.3164L907.25 37.6279L908.602 38.2764L901.243 53.5889L899.892 52.9395L892.532 68.25L893.884 68.8994L886.524 84.21L885.173 83.5615L881.493 91.2168C880.376 93.542 879.225 95.8443 878.041 98.123L879.369 98.8125C876.972 103.427 874.442 107.946 871.784 112.366L870.502 111.595C867.841 116.02 865.051 120.347 862.139 124.568L863.371 125.418C860.423 129.692 857.35 133.86 854.159 137.918L852.983 136.992C849.795 141.047 846.488 144.991 843.068 148.821L844.186 149.818C840.731 153.688 837.163 157.442 833.486 161.075L832.434 160.01C828.768 163.632 824.996 167.135 821.122 170.513L822.107 171.643C818.202 175.048 814.194 178.328 810.091 181.479L809.179 180.289C805.095 183.424 800.917 186.431 796.649 189.304L797.484 190.546C793.189 193.437 788.806 196.195 784.339 198.813L783.582 197.521C779.144 200.123 774.625 202.587 770.03 204.909L770.706 206.246C766.089 208.58 761.396 210.771 756.635 212.815L756.044 211.438C751.321 213.466 746.53 215.35 741.678 217.084L742.182 218.495C737.315 220.234 732.385 221.823 727.401 223.261L726.987 221.822C722.054 223.245 717.066 224.517 712.03 225.634L712.354 227.096C707.315 228.214 702.227 229.177 697.098 229.982L696.866 228.503C691.8 229.299 686.693 229.94 681.551 230.421L681.689 231.912C676.555 232.393 671.386 232.716 666.188 232.877L666.143 231.38C663.576 231.46 661.002 231.5 658.422 231.5H650.896V233H635.842V231.5H620.788V233H605.734V231.5H590.682V233H575.628V231.5H560.574V233H545.521V231.5H530.467V233H515.414V231.5H500.251V233H484.979V231.5H469.708V233H454.437V231.5H439.165V233H423.894V231.5H408.622V233H393.351V231.5H378.079V233H362.808V231.5H347.536V233H332.265V231.5H316.993V233H301.722V231.5H286.45V233H271.179V231.5H255.907V233H240.636V231.5H233C230.46 231.5 227.929 231.459 225.408 231.378L225.36 232.876C220.248 232.711 215.177 232.382 210.153 231.893L210.299 230.401C205.24 229.909 200.229 229.254 195.271 228.441L195.028 229.92C189.985 229.093 184.996 228.105 180.067 226.96L180.407 225.5C175.468 224.353 170.588 223.047 165.775 221.589L165.341 223.023C160.458 221.544 155.643 219.909 150.901 218.123L151.43 216.721C146.688 214.935 142.021 212.998 137.434 210.916L136.813 212.281C132.174 210.176 127.616 207.923 123.146 205.528L123.854 204.207C119.393 201.818 115.019 199.286 110.739 196.619L109.945 197.891C105.625 195.199 101.399 192.369 97.2744 189.408L98.1484 188.19C94.0419 185.243 90.0363 182.163 86.1367 178.959L85.1846 180.117C81.2545 176.888 77.4324 173.533 73.7236 170.058L74.749 168.965C71.0627 165.511 67.4891 161.937 64.0352 158.251L62.9414 159.275C59.4665 155.567 56.1107 151.745 52.8818 147.815L54.041 146.863C50.8371 142.964 47.7574 138.958 44.8096 134.852L43.5908 135.725C40.6298 131.6 37.8005 127.374 35.1084 123.054L36.3809 122.261C33.7138 117.981 31.1822 113.607 28.793 109.146L27.4707 109.854C25.0761 105.383 22.8232 100.825 20.7178 96.1855L22.084 95.5664C20.0021 90.979 18.0647 86.3116 16.2793 81.5703L14.877 82.0986C13.0913 77.3567 11.4551 72.5415 9.97559 67.6582L11.4111 67.2246C9.9531 62.4122 8.64744 57.5332 7.5 52.5938L6.03906 52.9316C4.89411 48.0028 3.90571 43.014 3.0791 37.9707L4.55859 37.7285C3.74602 32.7709 3.09094 27.7597 2.59863 22.7012L1.10645 22.8457C0.617559 17.822 0.287725 12.7517 0.123047 7.63965L1.62207 7.5918C1.55686 5.56769 1.51878 3.53698 1.50586 1.5H7.47656V0H22.4277V1.5H37.3799V0H52.3311V1.5H67.2832V0H82.2344V1.5H97.1855V0H112.138V1.5H127.089V0H142.041V1.5H156.992V0H171.944V1.5H186.896V0H201.848V1.5H216.799V0H231.75V1.5H246.702V0H261.653V1.5H276.605V0H291.557V1.5H306.509V0H321.46V1.5H336.411V0H351.363V1.5H366.314V0H381.267V1.5H396.218V0H411.17V1.5H426.121V0H441.073V1.5H456.024V0H470.976V1.5H485.928V0H500.879V1.5H515.831V0H530.782V1.5H545.734V0H560.686V1.5H575.637V0H590.589V1.5H605.54V0H620.492V1.5H635.443V0H650.396V1.5H665.347V0H680.299V1.5H695.25V0H710.201V1.5H725.153V0H740.104V1.5H755.057V0H770.008V1.5H784.96V0H799.911V1.5H814.863V0H829.814V1.5H844.767V0H859.718V1.5H874.669V0H889.621V1.5H904.572V0H919.524Z" fill="#d1d5dc" stroke="#050C58" stroke-width="3" stroke-dasharray="15 15"/>

      <path
        v-for="zone in zones"
        :key="zone.key"
        :d="zone.path"
        :fill="getBoxColor('white', zone.key)"
        stroke="black"
        stroke-width="5"
        class="cursor-pointer transition-all duration-200 hover:opacity-80"
        @click="toggleZone(zone.key)"
      />

      <text
        v-if="statsMode"
        v-for="zone in zones"
        :key="zone.key"
        :x="zone.textX"
        :y="zone.textY"
        :fill="getTextColor(zone.key)"
        pointer-events="none"
        text-anchor="middle"
        alignment-baseline="middle"
        font-size="35"
      >{{ getShootingAreaInfo(zone.key)['text'] }}</text>
      
      
      <rect @click="toggleZone('7M')" x="382.5" y="155.5" width="156" height="34" rx="17" :fill="getBoxColor('white','7M')" stroke="black" stroke-width="5"/>
      <text
        v-if="statsMode"
        :key="'7M'"
        x="460"
        y="175"
        :fill="getTextColor('7M')"
        pointer-events="none"
        text-anchor="middle"
        alignment-baseline="middle"
        font-size="35"
      >{{ getShootingAreaInfo('7M')['text'] }}</text>
    <path v-else d="M447.825 180L454.011 167.756V167.656H446.831V165.455H456.739V167.706L450.56 180H447.825ZM459.173 165.455H462.397L466.716 175.994H466.886L471.204 165.455H474.429V180H471.9V170.007H471.765L467.745 179.957H465.856L461.836 169.986H461.701V180H459.173V165.455Z":fill="selected === '7M' ? 'white' : 'black'"/>

    </svg>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import type { Player, Position, ShootingArea, ShootingTarget } from '~/types/handball';
import { getScoreColor } from '../utils/getScoreColor';

const props = defineProps<{
  player: Player | null,
  statsMode: boolean,
  selectedShootingTarget: ShootingTarget | null
}>() 
const emit = defineEmits<{
    (e: 'positionClick', index: ShootingArea | null): void
}>()

const selected = ref(null as ShootingArea | null);
const store = useHandballStore()

const zones = [
  // {key:"", path: "M447.825 180L454.011 167.756V167.656H446.831V165.455H456.739V167.706L450.56 180H447.825ZM459.173 165.455H462.397L466.716 175.994H466.886L471.204 165.455H474.429V180H471.9V170.007H471.765L467.745 179.957H465.856L461.836 169.986H461.701V180H459.173V165.455Z" },
  {key:"LW", textX:35,textY:95, path: "M2.50781 139.5V7.5L22.4283 33.7112C40.5062 57.4979 64.4361 76.1974 91.8876 87.9886L128 103.5L61.5 123L2.50781 139.5Z" }, 
  {key:"RW",textX:885,textY:90, path: "M924.5 131C923.719 82.3797 924.499 6.5 924.499 6.5L893.986 38.9866C883.381 50.2777 871.307 60.0933 858.089 68.1702L814.998 94.5L868.498 113.5L924.5 131Z"  },
  {key:"LB9",textX:120,textY:270, path: "M2.50781 143V317.5H311.008V231.5H210.467C158.979 231.5 109.955 209.45 75.7927 170.927L39.5 130L2.50781 143Z"  },
  {key:"RB9",textX:810,textY:270, path: "M924.508 132V317.5H616.008V231.5L670 230.5L692.71 229.106C715.365 227.714 737.554 222.051 758.105 212.413L772.496 205.664C790.335 197.298 806.415 185.608 819.876 171.219L872 115.5L924.508 132Z"  },
  {key:"LB6",textX:200,textY:170, path: "M43.5 131L80.4584 171.073C113.704 207.12 160.218 228.043 209.247 229.005L311 231V115L234 112L131.5 105L43.5 131Z"  },
  {key:"RB6",textX:710,textY:170, path: "M814.5 95L870 114.5L831.5 157.5L817.972 171.028C790.404 198.596 754.632 216.467 716.034 221.956L666.5 229L617 230V115L739.99 110.27C753.289 109.758 766.49 107.773 779.352 104.351L814.5 95Z"  },
  {key:"CB6",textX:460,textY:138, path: "M311 115V231H619V115L437.205 115H311Z"  },
  {key:"CB9",textX:460,textY:275, path: "M310.5 231.5V317.5H618V231.5H436.5H310.5Z"  },
] as {key: ShootingArea, textX:number, textY:number, path: string}[];



function toggleZone(i:ShootingArea) {
  if (selected.value === i) {
    selected.value = null;
    emit('positionClick', null);
  } else {
    selected.value = i;
    emit('positionClick', i); 
 }
}

watch(() => props.player?.position, (newPos) => {
  if(selected.value || props.statsMode) return;
  switch(props.player?.position){
    case 'LW':
      selected.value = "LW";
      break;
    case 'RW':
      selected.value = "RW";
      break;
    case 'LB':
      selected.value = "LB9";
      break;
    case 'RB':
      selected.value = "RB9";
      break;
    case 'CB':
      selected.value = "CB9";
      break;
    case 'PV':
      selected.value = "CB6";
      break;
    case 'GK':
      selected.value = null;
      break;
    default:
      selected.value = null;
  }
  emit('positionClick', selected.value);
}, { immediate: true });


function getShootingAreaInfo (target: ShootingArea){
  if(props.statsMode){
    if(props.player){
      const shots = props.player.currentShots?.filter(s => s.from === target)
      .filter(s => props.selectedShootingTarget ? s.to === props.selectedShootingTarget : true);
      const type = props.player.position === 'GK' ? "gksave" : "goal";
      const positive = shots?.filter(s => s.result === type).length ?? 0;
      const score = shots?.length ? (positive/shots.length*100) : -1;
      const color = getScoreColor(score) 
      
      return {text:`${positive}/${shots?.length ?? 0}`, color}
    }else{
      const shots = store.matches.match.value?.data.value?.shots
      .filter(s => s.from === target && s.result !== 'gkmiss' && s.result !== 'gksave')
      .filter(s => props.selectedShootingTarget ? s.to === props.selectedShootingTarget : true);
      const positive = shots?.filter(s => s.result === "goal").length ?? 0;
      const score = shots?.length ? (positive/shots.length*100) : -1;
      const color = getScoreColor(score) 
      return {text:`${positive}/${shots?.length ?? 0}`, color}
    }
  }else{
    return {text:target}
  }
}

function getBoxColor(defaultFill:string, index:ShootingArea){
  if(props.statsMode){
    if(selected.value === index){
      return "#050C58"
    }
    return getShootingAreaInfo(index).color?.boxColor
  }else{
    if(selected.value === index){
      return "#007a55"
    }
    return defaultFill
  }
}
function getTextColor(index:ShootingArea){
  if(props.statsMode){
    if(selected.value === index){
      return "white"
    }
    return getShootingAreaInfo(index).color?.textColor
  }else{
    if(selected.value === index){
      return "white"
    }
    return "#050C58"
  }
}


</script>

<style scoped>
svg {
  user-select: none;
}
</style>
